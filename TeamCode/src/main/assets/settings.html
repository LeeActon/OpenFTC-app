<!DOCTYPE HTML>
<html>
<head>
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <meta charset="utf-8">
      <link rel="stylesheet" href="/css/bootstrap.min.css">

      <link rel="stylesheet" href="JSONEditor/dist/jsoneditor.min.css" type="text/css">
      <script src="JSONEditor/dist/jsoneditor-minimalist.min.js"></script>
      <script src="js/jquery-3.1.1.min.js"></script>
      <script type="text/javascript" src="/js/bootstrap.min.js"></script>
      <link rel="stylesheet/less" type="text/css" href="/css/manage.less">
      <script type="text/javascript" src="/js/less.min.js"></script>
</head>
<body>
    <div class="bordered-text-block">
        <div>
            <h1>Robot Settings</h1>

            <p>Pick settings from this list to view and make changes to them. Remember to Click <b>Save As</b> to save the changes.</p>
            <p><select id="fileList"></select></p>
            <p></p>
            <p>MetaSettings are settings about settings. In particular it indicates which settings the robot controller should load on startup.</p>
            <p>Click <b>MetaSettings</b> to edit the current MetaSettings. Click <b>Active Settings</b> to edit the settings the robot controller has loaded.</p>
            <p>
                <input id="getMetaButton" class="aligned-select-button" type="button" value="MetaSettings"/>
                <input id="activeSettingsButton" class="aligned-select-button" type="button" value="Active Settings"/>
            </p>
        </div>
        <div>
            <p>Enter a name and click <b>Save As</b> to save changes to settings.</p>
            <p>
                <input id="saveButton" class="aligned-select-button" type="button" value="Save As"/><input id="fileName" class="centered-feedback" type="text">
            </p>
        </div>
        <div id="jsonEditor"></div>
        <div>
            <p>Click the link below to download the current settings to this computer.</p>
            <a id="downloadLink">></a>
        </div>
        <div id="statusMessage"></div>
    </div>

    <script>
        var currentFileName;
        var currentFileType;
        var jsonEditor;
        var $statusMessage;
        var $saveButton;
        var $saveButtonAs;
        var $downloadLink;
        var $fileList;
        var $fileName;
        var $activeSettingsButton;
        var $getMetaButton;

        function loadFilesList() {
            $.ajax("/settings",
                {
                method: "GET",
                success: function(jsonData, textStatus, jqXHR)
                    {
                    updateFilesList(jsonData);
                    }
                });
        }

        function updateFilesList(filesJson) {
            $fileList.empty();
            $.each(filesJson,
                function (key, value) {
                    $fileList.append($('<option></option>').attr('value', value).text(value));
                });
        }

        function setCurrentFileName(fileName) {
            var isNewName = (currentFileName != fileName);
            currentFileName = fileName;
            if (isNewName) {
                var fullPath = "/settings/" + currentFileName;
                $downloadLink.attr("href", fullPath);
                $downloadLink.text("Download " + fileName);
                $fileName.val(fileName);
            }

            return isNewName;
        }

        function save() { saveAs($fileName.val()); }

        function getSettingsAsText() {
            var text = jsonEditor.getText();

            return currentFileType + "\n" + text + "\n";
        }

        function loadJsonEditor(name, text) {
            var lines = text.split("\n");

            if (lines.length >= 2) {
                var data = JSON.parse(lines[1]);
                currentFileType = lines[0];
                jsonEditor.set(data);
                var parts = currentFileType.split(".");
                var className = "Object";
                if (parts.length > 1) {
                    className = parts[parts.length -1];
                }
                jsonEditor.setName(className + " " + name);
            }
        }

        function saveAs(fileName) {
            var isNewName = setCurrentFileName(fileName);
            $.ajax("/settings/" + fileName,
                {
                method: "PUT",
                data: getSettingsAsText(),
                success: function (data, textStatus, jqXHR)
                    {
                    $statusMessage.html(textStatus);
                    if (isNewName)
                        loadFilesList();
                    }
                });
        }

        function load(fileName) {
            setCurrentFileName(fileName);
            $.ajax("/settings/" + fileName,
                {
                method: "GET",
                success: function(data, textStatus, jqXHR)
                    {
                    loadJsonEditor(fileName, data);
                    $statusMessage.html("");
                    }
                });
        }

        function selectFile() {
            load($fileList.val());
        }

        function getMeta() {
            load("$meta");
            $fileName.val("meta");
        }

        function activeSettings() {
            load("$activeSettings");
            $fileName.val("");
        }

        $(document).ready(function() {
            $statusMessage = $("#statusMessage");
            $saveButton = $("#saveButton");
            $downloadLink = $("#downloadLink");
            $fileList = $("#fileList");
            $fileName = $("#fileName");
            $getMetaButton = $("#getMetaButton");
            $activeSettingsButton = $("#activeSettingsButton");

            jsonEditor = new JSONEditor($("#jsonEditor").get(0),
                {
                mode: 'form',
                modes: ['text', 'form'], // allowed modes
                onError: function (err) { $statusMessage.html(err.toString());},
                onEditable: function (node) { return {field: false, value: true}; },
                onChange: function () {},
                search: false
                }
            );

            activeSettings();
            loadFilesList();

            $saveButton.on("click", save);
            $getMetaButton.on("click", getMeta);
            $activeSettingsButton.on("click", activeSettings);
            $fileList.change(selectFile);
            }
            );
    </script>
</body>
</html>
